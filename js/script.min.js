(function(){
    const wheel = document.getElementById("wheelImage"),
          pointer = document.getElementById("pointerImage");
    let isSpinning = false,
        currentRotation = 0;
    const resultDisplay = document.querySelector('.result-display');

    // 定義有效的角度範圍
    const validRanges = [
        [0, 16],    // Free Single Scoop
        [20, 52],   // Free Topping
        [54, 88],   // 10% Off
        [128, 160], // Free Topping
        [200, 232], // Free Upsize
        [236, 268], // Free Topping
        [272, 304], // 10% Off
        [308, 340], // Free Upsize
        [344, 360]  // Free Single Scoop
    ];

    function getRandomValidAngle() {
        const validRangeIndex = Math.floor(Math.random() * validRanges.length);
        const [min, max] = validRanges[validRangeIndex];
        const randomAngle = min + Math.random() * (max - min);
        console.log(`Selected range: ${min}° - ${max}°, Generated angle: ${randomAngle}°`);
        return randomAngle;
    }

    function getRandomRotation() {
        const minRotations = 2160; // 最少旋轉6圈
        const randomAngle = getRandomValidAngle();
        return minRotations + randomAngle;
    }

    function triggerConfetti() {
        const wheelContainer = document.querySelector('.wheel-container');
        const rect = wheelContainer.getBoundingClientRect();
        
        // 計算轉盤中心點
        const originX = rect.left + (rect.width / 2);
        const originY = rect.top + (rect.height / 2);
        
        // 轉換為相對位置 (0-1)
        const normalizedX = originX / window.innerWidth;
        const normalizedY = originY / window.innerHeight;
        
        // 主要煙花效果
        window.confetti({
            particleCount: 300,  // 增加粒子數量
            spread: 120,         // 增加擴散範圍
            origin: {
                x: normalizedX,
                y: normalizedY
            },
            gravity: 1,          // 降低重力效果讓粒子飄得更遠
            ticks: 400,         // 增加持續時間
            colors: ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'], // 增加顏色
            shapes: ['square', 'circle', 'star'],  // 添加星形
            scalar: 1.5,        // 增加粒子大小
            zIndex: 1
        });

        // 延遲200ms後觸發第二波煙花
        setTimeout(() => {
            window.confetti({
                particleCount: 200,
                spread: 90,
                origin: {
                    x: normalizedX,
                    y: normalizedY
                },
                gravity: 1.2,
                ticks: 300,
                colors: ['#FFD700', '#FFA500', '#FF69B4', '#87CEEB', '#98FB98'],
                shapes: ['square', 'circle'],
                scalar: 1.2,
                zIndex: 1
            });
        }, 200);

        // 延遲400ms後觸發第三波煙花
        setTimeout(() => {
            window.confetti({
                particleCount: 150,
                spread: 160,    // 更大的擴散範圍
                origin: {
                    x: normalizedX,
                    y: normalizedY
                },
                gravity: 0.8,   // 更低的重力
                ticks: 500,     // 更長的持續時間
                colors: ['#FF1493', '#00CED1', '#FF8C00', '#32CD32', '#BA55D3'],
                shapes: ['star', 'circle'],
                scalar: 1.8,    // 更大的粒子
                zIndex: 1
            });
        }, 400);
    }

    function getPrizeContent(angle) {
        // 標準化角度到 0-360 範圍
        const normalizedAngle = ((angle % 360) + 360) % 360;
        
        // 定義獎品內容對應表
        const prizes = [
            { range: [0, 16], content: "CONGRATULATIONS!!!\nYOU WIN\n'FREE SINGLE SCOOP GELATO'" },
            { range: [20, 52], content: "CONGRATULATIONS!!!\nYOU WIN\n'FREE TOPPING OR NUTELLA DRIZZLE\nNEXT PURCHASE'" },
            { range: [54, 88], content: "CONGRATULATIONS!!!\nYOU WIN\n'10% OFF NEXT PURCHASE'" },
            { range: [128, 160], content: "CONGRATULATIONS!!!\nYOU WIN\n'FREE TOPPING OR NUTELLA DRIZZLE\nNEXT PURCHASE'" },
            { range: [200, 232], content: "CONGRATULATIONS!!!\nYOU WIN\n'FREE UPSIZE NEXT PURCHASE'" },
            { range: [236, 268], content: "CONGRATULATIONS!!!\nYOU WIN\n'FREE TOPPING OR NUTELLA DRIZZLE\nNEXT PURCHASE'" },
            { range: [272, 304], content: "CONGRATULATIONS!!!\nYOU WIN\n'10% OFF NEXT PURCHASE'" },
            { range: [308, 340], content: "CONGRATULATIONS!!!\nYOU WIN\n'FREE UPSIZE NEXT PURCHASE'" },
            { range: [344, 360], content: "CONGRATULATIONS!!!\nYOU WIN\n'FREE SINGLE SCOOP GELATO'" }
        ];
        
        // 查找對應的獎品
        const prize = prizes.find(p => 
            normalizedAngle >= p.range[0] && normalizedAngle <= p.range[1]
        );
        
        return prize ? prize.content : "Try Again";
    }
    
    function showResult(content) {
        resultDisplay.textContent = content;
        resultDisplay.classList.add('show');
    }
    
    function hideResult() {
        resultDisplay.classList.remove('show');
    }
    
    function rotateWheel() {
        if (isSpinning) return;
        
        // 開始旋轉時隱藏上一次的結果
        hideResult();
        
        isSpinning = true;
        pointer.classList.add('spinning');
        
        const targetRotation = getRandomRotation();
        const finalAngle = targetRotation % 360;
        console.log(`Target rotation: ${targetRotation}°, Final angle: ${finalAngle}°`);
        
        wheel.style.transform = `rotate(${targetRotation}deg)`;
        
        setTimeout(() => {
            isSpinning = false;
            pointer.classList.remove('spinning');
            currentRotation = finalAngle;
            
            // 保持最終角度
            wheel.style.transition = 'none';
            wheel.style.transform = `rotate(${currentRotation}deg)`;
            wheel.offsetHeight;
            wheel.style.transition = 'transform 5s cubic-bezier(0.2, 0.8, 0.3, 0.99)';
            
            // 觸發五彩紙屑效果
            triggerConfetti();
            
            // 顯示結果
            const prizeContent = getPrizeContent(finalAngle);
            showResult(prizeContent);
            
            // 保存角度
            localStorage.setItem('wheelAngle', currentRotation.toString());
        }, 5000);
    }

    pointer.addEventListener('click', rotateWheel);
    pointer.addEventListener('touchstart', function(e) {
        e.preventDefault();
        rotateWheel();
    });

    document.addEventListener('touchmove', function(e) {
        e.preventDefault();
    }, {passive: false});

    window.addEventListener('load', () => {
        wheel.style.transform = 'rotate(0deg)';
    });
})(); 